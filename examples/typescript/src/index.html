<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Sitck'Em Electronics Board Firmware Updater</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.19.0/css/xterm.css">
        <link
            href="https://fonts.googleapis.com/css?family=Orbitron"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link rel="icon" href="../assets/favicon.ico" />
        <link rel="stylesheet" href="styles.css" />
         <script src="https://cdn.jsdelivr.net/npm/xterm@4.19.0/lib/xterm.min.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
         <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
         <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    </head>
    <body>
        </div>
        <header style="background-color: #f8f9fa; padding: 10px; border-bottom: 2px solid #dee2e6; margin-bottom: 5px;">
            <div class="container">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="STICKEM-LOGO.png" alt="Stick'Em Logo" style="height: 60px; width: auto;">
                    <h1 style="margin: 0; font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 28px; color: #495057;">Stick'Em Electronics Board Firmware Updater</h1>
                    <div class="header-controls">
                        <label for="baudrates" id="lblBaudrate">Upload Speed:</label>
                        <select name="baudrates" id="baudrates">
                            <option value="921600">Fastest (For High-End Laptops)</option>
                            <option value="460800" selected>Fast</option>
                            <option value="230400">Average</option>
                            <option value="115200">Slow (Most Stable)</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>
        <div class="container" id="main">
            <hr/>
            <div class="status-board-display">
                <div class="status-line">
                    <span class="status-label">Status:</span>
                    <span class="status-value disconnected" id="connectionStatus">Disconnected</span>
                </div>
                <div class="board-name-line">
                    <span class="board-name-label">Board Name:</span>
                    <span class="board-name-value disconnected" id="boardStatus">No Board Detected</span>
                </div>
                
                <div class="change-name-button" id="changeNameButtonContainer">
                    <button class="btn btn-secondary btn-sm" id="changeNameButton">Change Board Name</button>
                </div>
                
                <div class="board-name-edit" id="boardNameEditSection">
                    <div>
                        <label for="boardName">New Board Name:</label>
                        <input type="text" id="boardName" placeholder="e.g. Stick 'Em B123" maxlength="50" />
                    </div>
                    <div class="board-name-note">
                        <small class="text-muted">Changes are saved automatically and will be applied when you flash firmware.</small>
                    </div>
                    <div class="board-name-buttons">
                        <button class="btn btn-secondary btn-sm" id="cancelNameChangeButton">Cancel</button>
                    </div>
                </div>
            </div>
            <div class="steps-grid">
                <div class="step-box focused step1-grid" id="step1">
                    <div class="step-number">Step 1</div>
                    <div class="step-emoji">ðŸ”Œ</div>
                    <div class="step-content">Connect your board via USB-C to update</div>
                </div>
                
                <div class="step-arrow">â†’</div>
                
                <div class="step-box unfocused step2-grid" id="step2">
                    <div class="step-number">Step 2</div>
                    <div class="step-content">UPDATE FIRMWARE</div>
                </div>
                
                <div class="action1-grid">
                    <input class="btn btn-success btn-lg" type="button" id="connectButton" value="Connect To Board" />
                    <input class="btn btn-danger btn-lg" type="button" id="disconnectButton" value="Disconnect" style="display: none;" />
                </div>
                
                <div class="action2-grid" id="firmwareActionSection" style="display: none;">
                    <button class="btn btn-success btn-lg" id="flashFirmwareButton">Flash Firmware</button>
                </div>
                
                <div class="feedback-area-grid">
                    <div class="feedback-content" id="feedbackContent">
                        Ready to connect...
                    </div>
                    
                    <!-- Progress Bar Section -->
                    <div class="progress-section" id="progressSection" style="display: none;">
                        <div class="progress-header">
                            <span class="progress-title">Firmware Update Progress</span>
                            <span class="progress-overall" id="progressOverall">0%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="progress-steps">
                            <div class="progress-step" id="step-start">
                                <div class="step-circle">1</div>
                                <div class="step-label">Start</div>
                                <div class="step-percentage" id="step-start-percent">0%</div>
                            </div>
                            <div class="progress-step" id="step-erasing">
                                <div class="step-circle">2</div>
                                <div class="step-label">Erasing Previous Firmware</div>
                                <div class="step-percentage" id="step-erasing-percent">0%</div>
                            </div>
                            <div class="progress-step" id="step-updating">
                                <div class="step-circle">3</div>
                                <div class="step-label">Updating Firmware</div>
                                <div class="step-percentage" id="step-updating-percent">0%</div>
                            </div>
                            <div class="progress-step" id="step-writing">
                                <div class="step-circle">4</div>
                                <div class="step-label">Writing Board Name</div>
                                <div class="step-percentage" id="step-writing-percent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="feedback-help" id="feedbackHelp" style="display: none;">
                <h4>Troubleshooting Steps:</h4>
                <ul>
                    <li>Make sure your board is connected via USB-C cable</li>
                    <li>Close any other tabs or applications using the serial port</li>
                    <li>Disconnect and reconnect the USB cable</li>
                    <li>Try selecting a slower upload speed (115200 baud)</li>
                    <li>Try refreshing the page and connecting again</li>
                </ul>
            </div>
            
            <div class="control-terminal-container">
                <div class="controls-section">
                    <div id="program">
                        <div class="alert alert-danger alert-dismissible" id="alertDiv" style="display:none; margin-top:10px">
                            <a href="#" class="close" aria-label="close" onclick="$('.alert').hide()">&times;</a>
                            <span id="alertmsg"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="advanced-options">
                <div class="advanced-toggle" id="advancedToggle">
                    <span class="advanced-toggle-text">Advanced Options</span>
                    <span class="advanced-arrow" id="advancedArrow">â–¼</span>
                </div>
                <div class="advanced-content" id="advancedContent">
                    <div class="control-terminal-container">
                        <div class="controls-section">
                            <label style="display:none" id="lblConnTo">Connected to device: </label>
                            <input class="btn btn-secondary btn-sm" type="button" id="manualConnectButton" value="Manual Connect" />
                        </div>
                        <div class="terminal-section">
                            <h3>Terminal</h3>
                            <div id="terminal"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="index.ts" type="module"></script>
        <script>
            // Safari 3.0+ "[object HTMLElementConstructor]"
            //var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && window['safari'].pushNotification));

            //if(isSafari)
            //{
            //   document.getElementById("safariErr").style.display = "inline";
            //   document.getElementById("main").style.display = "none";
            //}

            // Check Web Serial API support
            if (!('serial' in navigator)) {
                var alertDiv = document.getElementById("alertDiv");
                var alertMsg = document.getElementById("alertmsg");
                if (alertDiv && alertMsg) {
                    alertMsg.textContent = "Web Serial API is not supported in this browser. Please use Chrome, Edge, or another Chromium-based browser.";
                    alertDiv.style.display = "block";
                }
                
                var connectButton = document.getElementById("connectButton");
                if (connectButton) {
                    connectButton.disabled = true;
                    connectButton.title = "Web Serial API not supported";
                }
            }
        </script>
    </body>
</html>
